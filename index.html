<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rifa do JÃ£o</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <h1>ðŸŽ® Rifa do Controle 8BitDo</h1>
    <p class="descricao">Participe da rifa e concorra a um controle 8BitDo Wukong compatÃ­vel com PC e celular!</p>

    <img src="controle.jpg" alt="PrÃªmio da Rifa" class="premio-img" />

    <h2>Escolha seus nÃºmeros (R$2 cada):</h2>
    <div id="cotas" class="cotas"></div>

    <button id="confirmarBtn">Reservar Cotas</button>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <script>
    // Configure aqui sua URL e chave do Supabase
    const supabaseUrl = "https://oiwhhumfobnpnwxzdtaa.supabase.co";
    const supabaseKey = "SUA_CHAVE_PUBLICA_ANONIMA";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const cotasContainer = document.getElementById("cotas");
    const confirmarBtn = document.getElementById("confirmarBtn");
    const TOTAL_COTAS = 150;

    let cotasSelecionadas = [];

    // Busca todas as cotas e seus status
    async function atualizarCotas() {
      cotasContainer.innerHTML = "";
      cotasSelecionadas = [];

      const { data: cotas, error } = await supabase
        .from("cotas")
        .select("id, status");

      if (error) {
        console.error("Erro ao carregar cotas do Supabase:", error);
        cotasContainer.textContent = "Erro ao carregar cotas.";
        return;
      }

      const statusMap = {};
      cotas.forEach(cota => {
        statusMap[cota.id] = cota.status;
      });

      for(let i = 1; i <= TOTAL_COTAS; i++) {
        const div = document.createElement("div");
        div.textContent = i;

        const status = statusMap[i];

        if(status === "pago") {
          div.classList.add("paga");
          div.title = "Cota paga";
          div.style.cursor = "not-allowed";
        } else if(status === "reservada") {
          div.classList.add("ocupada");
          div.title = "Cota reservada";
          div.style.cursor = "not-allowed";
        } else {
          div.onclick = () => {
            if(div.classList.contains("selecionada")) {
              div.classList.remove("selecionada");
              cotasSelecionadas = cotasSelecionadas.filter(x => x !== i);
            } else {
              div.classList.add("selecionada");
              cotasSelecionadas.push(i);
            }
          };
        }

        cotasContainer.appendChild(div);
      }
    }

    // Confirmar cotas selecionadas e reservar no Supabase
    async function confirmarCotas() {
      if(cotasSelecionadas.length === 0) {
        alert("Selecione pelo menos uma cota.");
        return;
      }

      const nome = prompt("Digite seu nome ou apelido:");
      if(!nome) {
        alert("Nome obrigatÃ³rio!");
        return;
      }

      const telefone = prompt("Digite seu nÃºmero de WhatsApp (com DDD):");
      if(!telefone) {
        alert("WhatsApp obrigatÃ³rio!");
        return;
      }

      // Verifica se as cotas ainda estÃ£o disponÃ­veis
      const { data: cotas, error } = await supabase
        .from("cotas")
        .select("id, status")
        .in("id", cotasSelecionadas);

      if(error) {
        alert("Erro ao verificar cotas: " + error.message);
        return;
      }

      const indisponiveis = cotas.filter(c => c.status === "reservada" || c.status === "pago").map(c => c.id);
      if(indisponiveis.length > 0) {
        alert("As cotas jÃ¡ reservadas ou pagas: " + indisponiveis.join(", "));
        await atualizarCotas();
        return;
      }

      // Atualiza as cotas para status reservada
      for(const numero of cotasSelecionadas) {
        const { error } = await supabase
          .from("cotas")
          .update({
            nome: nome,
            telefone: telefone,
            status: "reservada",
            data_reserva: new Date().toISOString()
          })
          .eq("id", numero);

        if(error) {
          alert(`Erro ao reservar cota ${numero}: ${error.message}`);
          return;
        }
      }

      // Redireciona para pagamento passando dados via query string
      const query = `?nome=${encodeURIComponent(nome)}&telefone=${encodeURIComponent(telefone)}&cotas=${cotasSelecionadas.join(",")}`;
      window.location.href = "pagamento.html" + query;
    }

    confirmarBtn.addEventListener("click", confirmarCotas);
    atualizarCotas();
  </script>
</body>
</html>
